<?php
if ($argc != 3) {
    printf("[%s] Invalid arguments (requires 2, received %d)\n", $argv[0], $argc);
    printf("Usage:\n    %s [template] [index.html]\n", $argv[0]);
    exit(1);
}
$template  = $argv[1];
$indexHtml = $argv[2];

$dom = new DOMDocument();
$dom->loadHTMLFile($indexHtml);
$xpath = new DOMXPath($dom);
$nodes = $xpath->query('//div[@class="yui-g"]');
if ($nodes->length == 0) {
    file_put_contents('php://stderr', 'Unable to locate Composer package listing in HTML generated by Satis!');
    exit(1);
}
$node = $nodes->item(0);
$content = $dom->saveHTML($node);

$content = preg_replace('/^.*?(<h3>)/s', '$1', $content);
$content = preg_replace('/<\/div>\s*$/s', '', $content);
$content = str_replace('h3>', 'h4>', $content);

$template = file_get_contents($template);
$newIndex = str_replace('{%packages%}', $content, $template);
file_put_contents($indexHtml, $newIndex);
