<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>4.2. Database Table Authentication</title>
<link rel="stylesheet" type="text/css" href="dbstyle.css">
<meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1">
<link rel="home" href="index.html" title="Programmer's Reference Guide">
<link rel="up" href="zend.authentication.html" title="Chapter 4. Zend\Authentication">
<link rel="prev" href="zend.authentication.html" title="Chapter 4. Zend\Authentication">
<link rel="next" href="zend.authentication.adapter.digest.html" title="4.3. Digest Authentication">
<link rel="part" href="introduction.html" title="Part I. Introduction to Zend Framework">
<link rel="chapter" href="introduction.overview.html" title="Chapter 1. Overview">
<link rel="chapter" href="introduction.installation.html" title="Chapter 2. Installation">
<link rel="part" href="learning.html" title="Part II. Learning Zend Framework">
<link rel="article" href="learning.di.html" title="Learning Dependency Injection">
<link rel="part" href="reference.html" title="Part III. Zend Framework Reference">
<link rel="chapter" href="zend.acl.html" title="Chapter 3. Zend\Acl">
<link rel="chapter" href="zend.authentication.html" title="Chapter 4. Zend\Authentication">
<link rel="chapter" href="zend.barcode.html" title="Chapter 5. Zend\Barcode">
<link rel="chapter" href="zend.cache.html" title="Chapter 6. Zend\Cache">
<link rel="chapter" href="zend.captcha.html" title="Chapter 7. Zend\Captcha">
<link rel="chapter" href="zend.config.html" title="Chapter 8. Zend_Config">
<link rel="chapter" href="zend.crypt.html" title="Chapter 9. Zend_Crypt">
<link rel="chapter" href="zend.db.html" title="Chapter 10. Zend_Db">
<link rel="chapter" href="zend.di.html" title="Chapter 11. Zend\Di">
<link rel="chapter" href="zend.dom.html" title="Chapter 12. Zend\Dom">
<link rel="chapter" href="zend.event-manager.html" title="Chapter 13. Zend\EventManager">
<link rel="chapter" href="zend.form.html" title="Chapter 14. Zend_Form">
<link rel="chapter" href="zend.http.html" title="Chapter 15. Zend_Http">
<link rel="chapter" href="zend.i18n.html" title="Chapter 16. Zend_I18n">
<link rel="chapter" href="zend.input-filter.html" title="Chapter 17. Zend\InputFilter">
<link rel="chapter" href="zend.ldap.html" title="Chapter 18. Zend_Ldap">
<link rel="chapter" href="zend.loader.html" title="Chapter 19. Zend\Loader">
<link rel="refentry" href="zend.loader.autoloader-factory.methods.factory.html" title="factory">
<link rel="refentry" href="zend.loader.autoloader-factory.methods.get-registered-autoloaders.html" title="getRegisteredAutoloaders">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.constructor.html" title="__construct">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.add-static-map.html" title="addStaticMap">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.register-plugin.html" title="registerPlugin">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.register-plugins.html" title="registerPlugins">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.unregister-plugin.html" title="unregisterPlugin">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.get-registered-plugins.html" title="getRegisteredPlugins">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.is-loaded.html" title="isLoaded">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.get-class-name.html" title="getClassName">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.load.html" title="load">
<link rel="refentry" href="zend.loader.plugin-class-loader.methods.get-iterator.html" title="getIterator">
<link rel="refentry" href="zend.loader.short-name-locator.methods.is-loaded.html" title="isLoaded">
<link rel="refentry" href="zend.loader.short-name-locator.methods.get-class-name.html" title="getClassName">
<link rel="refentry" href="zend.loader.short-name-locator.methods.load.html" title="load">
<link rel="refentry" href="zend.loader.plugin-class-locator.methods.register-plugin.html" title="registerPlugin">
<link rel="refentry" href="zend.loader.plugin-class-locator.methods.unregister-plugin.html" title="unregisterPlugin">
<link rel="refentry" href="zend.loader.plugin-class-locator.methods.get-registered-plugins.html" title="getRegisteredPlugins">
<link rel="refentry" href="zend.loader.spl-autoloader.methods.constructor.html" title="__construct">
<link rel="refentry" href="zend.loader.spl-autoloader.methods.set-options.html" title="setOptions">
<link rel="refentry" href="zend.loader.spl-autoloader.methods.autoload.html" title="autoload">
<link rel="refentry" href="zend.loader.spl-autoloader.methods.register.html" title="register">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.constructor.html" title="__construct">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.set-options.html" title="setOptions">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.register-autoload-map.html" title="registerAutoloadMap">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.register-autoload-maps.html" title="registerAutoloadMaps">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.get-autoload-map.html" title="getAutoloadMap">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.autoload.html" title="autoload">
<link rel="refentry" href="zend.loader.class-map-autoloader.methods.register.html" title="register">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.constructor.html" title="__construct">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.set-options.html" title="setOptions">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.set-fallback-autoloader.html" title="setFallbackAutoloader">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.is-fallback-autoloader.html" title="isFallbackAutoloader">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.register-namespace.html" title="registerNamespace">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.register-namespaces.html" title="registerNamespaces">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.register-prefix.html" title="registerPrefix">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.register-prefixes.html" title="registerPrefixes">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.autoload.html" title="autoload">
<link rel="refentry" href="zend.loader.standard-autoloader.methods.register.html" title="register">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.constructor.html" title="__construct">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.add-static-paths.html" title="addStaticPaths">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.set-options.html" title="setOptions">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.add-prefix-path.html" title="addPrefixPath">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.add-prefix-paths.html" title="addPrefixPaths">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.get-paths.html" title="getPaths">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.clear-paths.html" title="clearPaths">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.remove-prefix-path.html" title="removePrefixPath">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.is-loaded.html" title="isLoaded">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.get-class-name.html" title="getClassName">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.load.html" title="load">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.get-plugin-map.html" title="getPluginMap">
<link rel="refentry" href="zend.loader.prefix-path-loader.methods.get-class-map.html" title="getClassMap">
<link rel="refentry" href="zend.loader.prefix-path-mapper.methods.add-prefix-path.html" title="addPrefixPath">
<link rel="refentry" href="zend.loader.prefix-path-mapper.methods.remove-prefix-path.html" title="removePrefixPath">
<link rel="chapter" href="zend.mail.html" title="Chapter 20. Zend\Mail">
<link rel="chapter" href="zend.module-manager.html" title="Chapter 21. Zend\ModuleManager">
<link rel="chapter" href="zend.mvc.html" title="Chapter 22. Zend\Mvc">
<link rel="chapter" href="zend.service-manager.html" title="Chapter 23. Zend\ServiceManager">
<link rel="chapter" href="zend.stdlib.html" title="Chapter 24. Zend\Stdlib">
<link rel="chapter" href="zend.uri.html" title="Chapter 25. Zend_Uri">
<link rel="chapter" href="zend.validator.html" title="Chapter 26. Zend\Validator">
<link rel="chapter" href="zend.view.html" title="Chapter 27. Zend_View">
<link rel="chapter" href="zend.xmlrpc.html" title="Chapter 28. Zend_XmlRpc">
<link rel="appendix" href="copyrights.html" title="Appendix A. Copyright Information">
<link rel="subsection" href="zend.authentication.adapter.dbtable.html#zend.authentication.adapter.dbtable.introduction" title="4.2.1. Introduction">
<link rel="subsection" href="zend.authentication.adapter.dbtable.html#zend.authentication.adapter.dbtable.advanced.storing_result_row" title="4.2.2. Advanced Usage: Persisting a DbTable Result Object">
<link rel="subsection" href="zend.authentication.adapter.dbtable.html#zend.authentication.adapter.dbtable.advanced.advanced_usage" title="4.2.3. Advanced Usage By Example">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader"><table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">4.2. Database Table Authentication</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="zend.authentication.html">Prev</a> </td>
<th width="60%" align="center">Chapter 4. Zend\Authentication</th>
<td width="20%" align="right"> <a accesskey="n" href="zend.authentication.adapter.digest.html">Next</a>
</td>
</tr>
</table></div>
<div class="section" title="4.2. Database Table Authentication">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="zend.authentication.adapter.dbtable"></a>4.2. Database Table Authentication</h2></div></div></div>
<div class="section" title="4.2.1. Introduction">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.authentication.adapter.dbtable.introduction"></a>4.2.1. Introduction</h3></div></div></div>
<p>
            <code class="classname">Zend\Authentication\Adapter\DbTable</code> provides the ability to
            authenticate against credentials stored in a database table. Because
            <code class="classname">Zend\Authentication\Adapter\DbTable</code> requires an instance of
            <code class="classname">Zend\Db\Adapter\Adapter</code> to be passed to its
            constructor, each instance is bound to a particular database
            connection. Other configuration options may be set through the
            constructor and through instance methods, one for each option.
        </p>
<p>
            The available configuration options include:
        </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>
                    <span class="emphasis"><em><span class="property">tableName</span></em></span>: This is the name of the
                    database table that contains the authentication credentials,
                    and against which the database authentication query is
                    performed.
                </p></li>
<li class="listitem"><p>
                    <span class="emphasis"><em><span class="property">identityColumn</span></em></span>: This is the name of
                    the database table column used to represent the identity.
                    The identity column must contain unique values, such as
                    a username or e-mail address.
                </p></li>
<li class="listitem"><p>
                    <span class="emphasis"><em><span class="property">credentialColumn</span></em></span>: This is the name
                    of the database table column used to represent the credential.
                    Under a simple identity and password authentication
                    scheme, the credential value corresponds to the
                    password. See also the <span class="property">credentialTreatment</span>
                    option.
                </p></li>
<li class="listitem"><p>
                    <span class="emphasis"><em><span class="property">credentialTreatment</span></em></span>: In many cases,
                    passwords and other sensitive data are encrypted,
                    hashed, encoded, obscured, salted or otherwise treated
                    through some function or algorithm. By specifying a
                    parameterized treatment string with this method, such as
                    '<code class="methodname">MD5(?)</code>' or
                    '<code class="methodname">PASSWORD(?)</code>', a
                    developer may apply such arbitrary <acronym class="acronym">SQL</acronym> upon input
                    credential data. Since these functions are specific to
                    the underlying <acronym class="acronym">RDBMS</acronym>, check the database manual for the
                    availability of such functions for your database system.
                </p></li>
</ul></div>
<div class="example">
<a name="zend.authentication.adapter.dbtable.introduction.example.basic_usage"></a><p class="title"><b>Example 4.3. Basic Usage</b></p>
<div class="example-contents">
<p>
                As explained in the introduction, the
                <code class="classname">Zend\Authentication\Adapter\DbTable</code> constructor requires an
                instance of <code class="classname">Zend\Db\Adapter\Adapter</code> that serves as
                the database connection to which the authentication adapter
                instance is bound. First, the database connection should be
                created.
            </p>
<p>
                The following code creates an adapter for an in-memory database,
                creates a simple table schema, and inserts a row against
                which we can perform an authentication query later. This example
                requires the <acronym class="acronym">PDO</acronym> SQLite extension to be available:
            </p>
<pre class="programlisting">
use Zend\Db\Adapter\Adapter as DbAdapter;

// Create a SQLite database connection
$dbAdapter = new DbAdapter(array(
                'driver' =&gt; 'Pdo_Sqlite',
                'database' =&gt; 'path/to/sqlite.db'
            ));

// Build a simple table creation query
$sqlCreate = 'CREATE TABLE [users] ('
           . '[id] INTEGER  NOT NULL PRIMARY KEY, '
           . '[username] VARCHAR(50) UNIQUE NOT NULL, '
           . '[password] VARCHAR(32) NULL, '
           . '[real_name] VARCHAR(150) NULL)';

// Create the authentication credentials table
$dbAdapter-&gt;query($sqlCreate);

// Build a query to insert a row for which authentication may succeed
$sqlInsert = "INSERT INTO users (username, password, real_name) "
           . "VALUES ('my_username', 'my_password', 'My Real Name')";

// Insert the data
$dbAdapter-&gt;query($sqlInsert);
</pre>
<p>
                With the database connection and table data available, an
                instance of <code class="classname">Zend\Authentication\Adapter\DbTable</code> may be
                created. Configuration option values may be passed to the
                constructor or deferred as parameters to setter methods after
                instantiation:
            </p>
<pre class="programlisting">
use Zend\Authentication\Adapter\DbTable as AuthAdapter;

// Configure the instance with constructor parameters...
$authAdapter = new AuthAdapter($dbAdapter,
                               'users',
                               'username',
                               'password'
                               );

// ...or configure the instance with setter methods
$authAdapter = new AuthAdapter($dbAdapter);

$authAdapter
    -&gt;setTableName('users')
    -&gt;setIdentityColumn('username')
    -&gt;setCredentialColumn('password')
;
</pre>
<p>
                At this point, the authentication adapter instance is ready to
                accept authentication queries. In order to formulate an
                authentication query, the input credential values are passed to
                the adapter prior to calling the <code class="methodname">authenticate()</code>
                method:
            </p>
<pre class="programlisting">
// Set the input credential values (e.g., from a login form)
$authAdapter
    -&gt;setIdentity('my_username')
    -&gt;setCredential('my_password')
;

// Perform the authentication query, saving the result
</pre>
<p>
                In addition to the availability of the
                <code class="methodname">getIdentity()</code> method upon the authentication result
                object, <code class="classname">Zend\Authentication\Adapter\DbTable</code> also supports
                retrieving the table row upon authentication success:
            </p>
<pre class="programlisting">
// Print the identity
echo $result-&gt;getIdentity() . "\n\n";

// Print the result row
print_r($authAdapter-&gt;getResultRowObject());

/* Output:
my_username

Array
(
    [id] =&gt; 1
    [username] =&gt; my_username
    [password] =&gt; my_password
    [real_name] =&gt; My Real Name
)
</pre>
<p>
                Since the table row contains the credential value, it is
                important to secure the values against unintended access.
            </p>
</div>
</div>
<br class="example-break">
</div>
<div class="section" title="4.2.2. Advanced Usage: Persisting a DbTable Result Object">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.authentication.adapter.dbtable.advanced.storing_result_row"></a>4.2.2. Advanced Usage: Persisting a DbTable Result Object</h3></div></div></div>
<p>
            By default, <code class="classname">Zend\Authentication\Adapter\DbTable</code> returns the
            identity supplied back to the auth object upon successful
            authentication. Another use case scenario, where developers want to
            store to the persistent storage mechanism of <code class="classname">Zend\Authentication</code>
            an identity object containing other useful information, is solved by
             using the <code class="methodname">getResultRowObject()</code> method to return a
            <span class="emphasis"><em>stdClass</em></span> object. The following code snippet illustrates
            its use:
        </p>
<pre class="programlisting">
// authenticate with Zend\Authentication\Adapter\DbTable
$result = $this-&gt;_auth-&gt;authenticate($adapter);

if ($result-&gt;isValid()) {
    // store the identity as an object where only the username and
    // real_name have been returned
    $storage = $this-&gt;_auth-&gt;getStorage();
    $storage-&gt;write($adapter-&gt;getResultRowObject(array(
        'username',
        'real_name',
    )));

    // store the identity as an object where the password column has
    // been omitted
    $storage-&gt;write($adapter-&gt;getResultRowObject(
        null,
        'password'
    ));

    /* ... */

} else {

    /* ... */

}
</pre>
</div>
<div class="section" title="4.2.3. Advanced Usage By Example">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.authentication.adapter.dbtable.advanced.advanced_usage"></a>4.2.3. Advanced Usage By Example</h3></div></div></div>
<p>
            While the primary purpose of the <code class="classname">Zend\Authentication</code> component (and consequently
            <code class="classname">Zend\Authentication\Adapter\DbTable</code>) is primarily
            <span class="emphasis"><em>authentication</em></span> and not
            <span class="emphasis"><em>authorization</em></span>, there are a few
            instances and problems that toe the line between which domain they fit
            within. Depending on how you've decided to explain your problem, it
             sometimes makes sense to solve what could look like an
             authorization problem within the authentication adapter.
        </p>
<p>
            With that disclaimer out of the way, <code class="classname">Zend\Authentication\Adapter\DbTable</code>
            has some built in mechanisms that can be leveraged for additional checks at
            authentication time to solve some common user problems.
        </p>
<pre class="programlisting">
use Zend\Authentication\Adapter\DbTable as AuthAdapter;

// The status field value of an account is not equal to "compromised"
$adapter = new AuthAdapter($db,
                           'users',
                           'username',
                           'password',
                           'MD5(?) AND status != "compromised"'
                           );

// The active field value of an account is equal to "TRUE"
$adapter = new AuthAdapter($db,
                           'users',
                           'username',
                           'password',
                           'MD5(?) AND active = "TRUE"'
                           );
</pre>
<p>
            Another scenario can be the implementation of a salting mechanism.
            Salting is a term referring to a technique which can highly improve
            your application's security. It's based on the idea that
            concatenating a random string to every password makes it impossible
            to accomplish a successful brute force attack on the database using
            pre-computed hash values from a dictionary.
        </p>
<p>
            Therefore, we need to modify our table to store our salt string:
        </p>
<pre class="programlisting">
$sqlAlter = "ALTER TABLE [users] "
          . "ADD COLUMN [password_salt] "
          . "AFTER [password]";
</pre>
<p>
            Here's a simple way to generate a salt string for every user at
            registration:
        </p>
<pre class="programlisting">
for ($i = 0; $i &lt; 50; $i++) {
    $dynamicSalt .= chr(rand(33, 126));
</pre>
<p>
            And now let's build the adapter:
        </p>
<pre class="programlisting">
$adapter = new AuthAdapter($db,
                           'users',
                           'username',
                           'password',
                           "MD5(CONCAT('"
                                . Zend\Registry::get('staticSalt')
                                . "', ?, password_salt))"
                          );
</pre>
<div class="note" title="Note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>
                You can improve security even more by using a static salt value
                hard coded into your application. In the case that your database
                is compromised (e. g. by an <acronym class="acronym">SQL</acronym> injection attack) but your web
                server is intact your data is still unusable for the attacker.
            </p></td></tr>
</table></div>
<p>
            Another alternative is to use the <code class="methodname">getDbSelect()</code> method
            of the <code class="classname">Zend\Authentication\Adapter\DbTable</code> after the adapter has been
            constructed. This method will return the <code class="classname">Zend\Db\Sql\Select</code> object
            instance it will use to complete the <code class="methodname">authenticate()</code> routine.
            It is important to note that this method will always return the same object regardless
            if <code class="methodname">authenticate()</code> has been called or not. This object
            <span class="emphasis"><em>will not</em></span> have any of the identity or credential information in it
            as those values are placed into the select object at
            <code class="methodname">authenticate()</code> time.
        </p>
<p>
            An example of a situation where one might want to use the
            <code class="methodname">getDbSelect()</code> method would check the status of a user, in
            other words to see if that user's account is enabled.
        </p>
<pre class="programlisting">
// Continuing with the example from above
$adapter = new AuthAdapter($db,
                           'users',
                           'username',
                           'password',
                           'MD5(?)'
                           );

// get select object (by reference)
$select = $adapter-&gt;getDbSelect();
$select-&gt;where('active = "TRUE"');

// authenticate, this ensures that users.active = TRUE
$adapter-&gt;authenticate();
</pre>
</div>
</div>
<div class="navfooter"><table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="zend.authentication.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="zend.authentication.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="zend.authentication.adapter.digest.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 4. Zend\Authentication </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> 4.3. Digest Authentication</td>
</tr>
</table></div>
<div class="revinfo"></div>
</body>
</html>
